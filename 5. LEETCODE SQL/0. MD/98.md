# Intuition

IPv4 addresses are stored as **strings**, so SQL cannot validate them directly as numbers.
To find **invalid IP addresses**, we must manually check whether the structure and
values of each address violate IPv4 rules.

An IP should be marked invalid if **any** of the following conditions are true:

- It does not contain exactly **4 octets**
- Any octet has a numeric value **greater than 255**
- Any octet contains **leading zeros** (except the single value `0`)

The idea is to translate each of these rules into SQL conditions and flag rows
that break at least one rule.

---

# Approach

1. **Check the IP structure**
   - Count the number of dots (`.`) in the IP string.
   - A valid IPv4 address must have exactly **3 dots**.

2. **Validate numeric range of each octet**
   - Extract each octet using `SUBSTRING_INDEX`.
   - Convert it to a number using `CAST(... AS UNSIGNED)`.
   - Check whether any octet exceeds `255`.

3. **Detect leading zeros**
   - Use a regular expression to find octets that start with `0` followed by
     more digits (e.g. `01`, `002`).
   - Apply this check to all four octets.

4. **Combine conditions**
   - Use `OR` so that **any single violation** marks the IP as invalid.

5. **Aggregate results**
   - Group by `ip` to count how many times each invalid IP appears.
   - Order results by `invalid_count` (descending) and then by `ip` (descending).

---

# Complexity

- **Time complexity:**  
  $$O(n)$$  
  Each log entry is processed once, with constant-time string and numeric checks.

- **Space complexity:**  
  $$O(1)$$  
  No additional data structures are used beyond aggregation.

---

# Code

```mysql
SELECT
    ip,
    COUNT(*) AS invalid_count
FROM logs
WHERE
    LENGTH(ip) - LENGTH(REPLACE(ip, '.', '')) <> 3

    OR

    CAST(SUBSTRING_INDEX(ip, '.', 1) AS UNSIGNED) > 255
    OR CAST(SUBSTRING_INDEX(SUBSTRING_INDEX(ip, '.', 2), '.', -1) AS UNSIGNED) > 255
    OR CAST(SUBSTRING_INDEX(SUBSTRING_INDEX(ip, '.', 3), '.', -1) AS UNSIGNED) > 255
    OR CAST(SUBSTRING_INDEX(ip, '.', -1) AS UNSIGNED) > 255

    OR

    (SUBSTRING_INDEX(ip, '.', 1) REGEXP '^0[0-9]+')
    OR (SUBSTRING_INDEX(SUBSTRING_INDEX(ip, '.', 2), '.', -1) REGEXP '^0[0-9]+')
    OR (SUBSTRING_INDEX(SUBSTRING_INDEX(ip, '.', 3), '.', -1) REGEXP '^0[0-9]+')
    OR (SUBSTRING_INDEX(ip, '.', -1) REGEXP '^0[0-9]+')
GROUP BY ip
ORDER BY invalid_count DESC, ip DESC;
ORDER BY invalid_count DESC, ip DESC;
```
