# Intuition

We want to analyze user prompt usage and identify users who:

- have written **at least 3 prompts**
- have at least one prompt whose token count is **greater than their average token usage**

To do this correctly, we must first compute **per-user aggregates** such as:

- total number of prompts
- maximum tokens used in a single prompt
- average tokens per prompt

These aggregate values cannot be compared directly in the same query block where they are computed, so we need a staged approach.

---

# Approach

1. **Aggregate per user** in a subquery:
   - Count the number of prompts per `user_id`
   - Find the maximum tokens used (`MAX(tokens)`)
   - Compute the average tokens (`AVG(tokens)`)

2. **Filter aggregated results** in the outer query:
   - Keep users with `prompt_count >= 3`
   - Keep users where `max_tokens > avg_tokens`

3. **Order the results** by average tokens (descending) and `user_id` (ascending)

This avoids illegal use of aggregate functions in the `WHERE` clause.

---

# Complexity

- **Time Complexity:**  
  $$O(n)$$ — each prompt row is processed once during aggregation.

- **Space Complexity:**  
  $$O(u)$$ — where `u` is the number of distinct users (aggregated result size).

---

# Code

```sql
SELECT
    user_id,
    prompt_count,
    avg_tokens
FROM (
    SELECT
        user_id,
        COUNT(prompt) AS prompt_count,
        MAX(tokens) AS max_tokens,
        ROUND(AVG(tokens), 2) AS avg_tokens
    FROM prompts
    GROUP BY user_id
) t
WHERE max_tokens > avg_tokens
  AND prompt_count >= 3
ORDER BY avg_tokens DESC, user_id ASC;
```
