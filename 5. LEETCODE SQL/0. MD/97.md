# Intuition

To build a “customers who bought this also bought” feature, we need to discover
**products that are frequently purchased together by the same users**.
The core idea is to look at each user’s purchase history, form all possible
pairs of products they bought, and then count how many different users bought
each pair.

Only product pairs purchased together by **at least three distinct customers**
should be recommended.

---

# Approach

1. **Generate product pairs per user**
   - Perform a self-join on the `ProductPurchases` table using `user_id`.
   - Enforce `product1_id < product2_id` to avoid duplicate and reversed pairs.

2. **Count customers per product pair**
   - Group by `(product1_id, product2_id)` and count distinct `user_id`s.
   - Keep only those pairs with at least three different customers.

3. **Attach product metadata**
   - Join the resulting pairs with the `ProductInfo` table twice to retrieve
     the category of each product in the pair.

4. **Sort the results**
   - Order by `customer_count` in descending order.
   - Break ties by `product1_id` and `product2_id` in ascending order.

---

# Complexity

- **Time complexity:**  
  $$O(n^2)$$ in the worst case per user due to pair generation,  
  but practical performance is acceptable because purchases per user are limited.

- **Space complexity:**  
  $$O(n)$$ for storing intermediate product pairs and aggregated results.

---

# Code

```mysql
WITH user_pairs AS (
    SELECT
        p1.user_id,
        p1.product_id AS product1_id,
        p2.product_id AS product2_id
    FROM ProductPurchases p1
    JOIN ProductPurchases p2
        ON p1.user_id = p2.user_id
       AND p1.product_id < p2.product_id
),
pair_counts AS (
    SELECT
        product1_id,
        product2_id,
        COUNT(DISTINCT user_id) AS customer_count
    FROM user_pairs
    GROUP BY product1_id, product2_id
    HAVING COUNT(DISTINCT user_id) >= 3
)
SELECT
    pc.product1_id,
    pc.product2_id,
    pi1.category AS product1_category,
    pi2.category AS product2_category,
    pc.customer_count
FROM pair_counts pc
JOIN ProductInfo pi1
    ON pc.product1_id = pi1.product_id
JOIN ProductInfo pi2
    ON pc.product2_id = pi2.product_id
ORDER BY
    pc.customer_count DESC,
    pc.product1_id ASC,
    pc.product2_id ASC;
```
