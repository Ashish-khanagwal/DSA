# Intuition

A _Study Spiral Pattern_ depends on **how a student studies over time**, not on individual sessions.  
The main idea is to examine each student’s study sessions **in chronological order** and check whether they:

- Study **multiple subjects**
- Do so **continuously** (no long gaps)
- Accumulate enough sessions to form **at least two full cycles** of those subjects

This naturally suggests grouping data by student and using ordered analysis on dates.

---

# Approach

1. **Order study sessions per student**  
   Use a window function (`LAG`) to compare each session’s date with the previous one.

2. **Filter valid (continuous) sessions**  
   Keep sessions where the gap from the previous session is **no more than 2 days**.

3. **Aggregate at the student level**  
   For each student:
   - Count total sessions
   - Count distinct subjects (this is the cycle length)
   - Sum total study hours

4. **Apply Study Spiral rules**
   - Cycle length must be at least 3 subjects
   - Total sessions must be at least twice the cycle length (2 full cycles)

5. **Join student details and sort results**  
   Return student information ordered by:
   - Cycle length (descending)
   - Total study hours (descending)

---

# Complexity

- **Time complexity:**  
  $$O(n)$$  
  Each study session is processed once, and window functions operate linearly per student.

- **Space complexity:**  
  $$O(n)$$  
  Intermediate CTEs store ordered and filtered session data.

---

# Code

```mysql
WITH ordered_sessions AS (
    SELECT
        s.student_id,
        s.subject,
        s.session_date,
        s.hours_studied,
        LAG(s.session_date) OVER (
            PARTITION BY s.student_id
            ORDER BY s.session_date
        ) AS prev_date
    FROM study_sessions s
),
valid_sessions AS (
    SELECT
        student_id,
        subject,
        session_date,
        hours_studied
    FROM ordered_sessions
    WHERE prev_date IS NULL
       OR DATEDIFF(session_date, prev_date) <= 2
),
student_agg AS (
    SELECT
        student_id,
        COUNT(*) AS session_count,
        COUNT(DISTINCT subject) AS cycle_length,
        SUM(hours_studied) AS total_study_hours
    FROM valid_sessions
    GROUP BY student_id
)
SELECT
    st.student_id,
    st.student_name,
    st.major,
    sa.cycle_length,
    sa.total_study_hours
FROM student_agg sa
JOIN students st
  ON sa.student_id = st.student_id
WHERE sa.cycle_length >= 3
  AND sa.session_count >= 2 * sa.cycle_length
ORDER BY
    sa.cycle_length DESC,
    sa.total_study_hours DESC;
```
