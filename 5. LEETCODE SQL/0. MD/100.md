# Intuition

Each user can purchase products from multiple categories.  
If a user has purchased from **two different categories**, that pair of categories
represents a potential **cross-category shopping pattern**.

To find meaningful category recommendation pairs, we need to identify:

- Which **category pairs** appear together for the same user
- How many **distinct users** purchased from both categories
- Keep only pairs shared by **at least 3 users**

This is a classic **co-occurrence problem**, but at the **category level** instead
of the product level.

---

# Approach

1. **Map purchases to categories**
   - Join `ProductPurchases` with `ProductInfo` to convert product purchases into
     `(user_id, category)` pairs.
   - Use `DISTINCT` to ensure each user is counted only once per category.

2. **Generate category pairs per user**
   - Perform a self-join on the user–category data using `user_id`.
   - Enforce `category1 < category2` to:
     - Avoid duplicate reversed pairs (A–B and B–A)
     - Avoid self-pairs (A–A)

3. **Count shared customers**
   - Group by `(category1, category2)` and count distinct users.
   - Keep only category pairs with at least **3 shared customers**.

4. **Sort the result**
   - Order by `customer_count` (descending)
   - Break ties using `category1` and `category2` in ascending lexicographical order.

---

# Complexity

- **Time complexity:**  
  $$O(n^2)$$ in the worst case due to generating category pairs per user,  
  though practical performance is typically much better since each user
  purchases from a limited number of categories.

- **Space complexity:**  
  $$O(n)$$ for storing intermediate user–category mappings and aggregated results.

---

# Code

```mysql
WITH user_categories AS (
    SELECT DISTINCT
        pp.user_id,
        pi.category
    FROM ProductPurchases pp
    JOIN ProductInfo pi
        ON pp.product_id = pi.product_id
),
category_pairs AS (
    SELECT
        uc1.category AS category1,
        uc2.category AS category2,
        uc1.user_id
    FROM user_categories uc1
    JOIN user_categories uc2
        ON uc1.user_id = uc2.user_id
       AND uc1.category < uc2.category
),
pair_counts AS (
    SELECT
        category1,
        category2,
        COUNT(DISTINCT user_id) AS customer_count
    FROM category_pairs
    GROUP BY category1, category2
    HAVING COUNT(DISTINCT user_id) >= 3
)
SELECT
    category1,
    category2,
    customer_count
FROM pair_counts
ORDER BY
    customer_count DESC,
    category1 ASC,
    category2 ASC;
```
