# Intuition

We want to identify **customers with stable purchasing behavior** based on three conditions:

1. The customer has made **at least 3 transactions**
2. The customer has been active for **at least 30 days**
3. The customer’s **refund rate is below 20%**

Since all of these conditions depend on **aggregated information per customer**, we must first compute per-customer metrics and then apply filters on those aggregates.

---

# Approach

1. **Aggregate transactions per customer**:
   - Count total transactions
   - Find the first and last transaction dates
   - Count how many transactions are refunds

2. **Compute derived metrics**:
   - Activity duration using `DATEDIFF(MAX(date), MIN(date))`
   - Refund rate as  
     `(number of refunds / total transactions) × 100`

3. **Filter aggregated results**:
   - Keep customers with at least 3 transactions
   - Ensure activity duration is at least 30 days
   - Ensure refund rate is below 20%

4. **Sort the final result** by `customer_id`

---

# Complexity

- **Time Complexity:**  
  $$O(n)$$ — each transaction record is processed once during aggregation.

- **Space Complexity:**  
  $$O(c)$$ — where `c` is the number of distinct customers.

---

# Code

```sql
SELECT customer_id
FROM (
    SELECT
        customer_id,
        COUNT(transaction_type) AS transactions,
        DATEDIFF(MAX(transaction_date), MIN(transaction_date)) AS duration,
        100.0 *
        SUM(CASE WHEN transaction_type = 'refund' THEN 1 ELSE 0 END)
        / COUNT(transaction_type) AS refund_rate
    FROM customer_transactions
    GROUP BY customer_id
) t
WHERE transactions >= 3
  AND duration >= 30
  AND refund_rate < 20
ORDER BY customer_id;
```
