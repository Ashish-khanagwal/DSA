# ðŸ§  Intuition

We need to identify **high-value customers** based on multiple behavioral conditions:

1. They have placed **enough orders** to be meaningful (at least 3).
2. They tend to order during **peak hours** (lunch or dinner).
3. They provide **good feedback** (average rating â‰¥ 4).
4. They are **actively rating their orders** (at least 50% of orders rated).

To solve this, we aggregate data **per customer** and compute derived metrics like:

- total orders
- percentage of peak-hour orders
- average rating
- rating coverage ratio

All filters depend on aggregated values, so the logic naturally belongs in the `HAVING` clause.

---

# ðŸ§© Approach

1. **Group by `customer_id`** to analyze each customer independently.
2. **Count total orders** using `COUNT(order_id)`.
3. **Identify peak-hour orders** using a `CASE` statement on `order_timestamp`:
   - Lunch: 11:00â€“14:00
   - Dinner: 18:00â€“21:00
4. **Compute peak-hour percentage** as: `(peak_orders / total_orders) * 100` and round it up using `CEILING`.
5. **Compute average rating** using `AVG(order_rating)` (automatically ignores NULLs).
6. **Ensure rating coverage** by checking:
   `COUNT(order_rating) / COUNT(order_id) â‰¥ 0.5`

7. Apply all business rules in the **HAVING clause**, since they depend on aggregates.
8. Sort results by highest average rating first, then by customer ID.

---

# â±ï¸ Complexity

- **Time complexity:**  
  $$O(n)$$  
  (single scan of the `restaurant_orders` table with grouping)

- **Space complexity:**  
  $$O(k)$$  
  where `k` is the number of distinct customers (groups held in memory)

---

# ðŸ’» Code

```mysql
SELECT
 customer_id,
 COUNT(order_id) AS total_orders,

 CEILING(
     SUM(
         CASE
             WHEN TIME(order_timestamp) BETWEEN '11:00:00' AND '14:00:00'
               OR TIME(order_timestamp) BETWEEN '18:00:00' AND '21:00:00'
             THEN 1
             ELSE 0
         END
     ) * 100.0 / COUNT(order_id)
 ) AS peak_hour_percentage,

 ROUND(
     AVG(order_rating),
     2
 ) AS average_rating

FROM restaurant_orders
GROUP BY customer_id
HAVING COUNT(order_id) >= 3
AND AVG(order_rating) >= 4
AND (COUNT(order_rating) * 1.0 / COUNT(order_id)) >= 0.5
AND peak_hour_percentage >= 60
ORDER BY average_rating DESC, customer_id DESC;
```
