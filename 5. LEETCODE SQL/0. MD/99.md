# Intuition

The `Employees` table represents an **organizational hierarchy** where each employee
may manage other employees, forming a tree structure.  
To analyze this hierarchy, we need to derive information that is **not explicitly
stored** in the table:

- The **level** of each employee in the organization
- The **total team size** under each employee (direct + indirect reports)
- The **total salary budget** controlled by each employee

Since both the reporting chain and the aggregation of subordinates require traversing
the hierarchy, a **recursive approach** is necessary.

---

# Approach

1. **Build the hierarchy and levels**
   - Use a recursive CTE starting from the CEO(s) (`manager_id IS NULL`).
   - Assign level `1` to the CEO and increment the level as we move down the tree.

2. **Generate manager–descendant relationships**
   - Use another recursive CTE to associate each manager with **all employees in
     their subtree**, including themselves.
   - This allows aggregation across both direct and indirect reports.

3. **Aggregate team size and budget**
   - For each manager:
     - `team_size` is the number of descendants minus one (to exclude the manager).
     - `budget` is the sum of salaries of all descendants, including the manager.

4. **Combine results and sort**
   - Join the hierarchy data with the aggregated metrics.
   - Order the output by level (ascending), budget (descending), and employee name
     (ascending).

---

# Complexity

- **Time complexity:**  
  $$O(n^2)$$ in the worst case, since recursive traversal may generate manager–descendant
  pairs across the hierarchy.

- **Space complexity:**  
  $$O(n^2)$$ due to storing all manager–descendant relationships in the recursive CTE.

---

# Code

```mysql
WITH RECURSIVE hierarchy AS (
    -- Base case: CEO(s)
    SELECT
        employee_id,
        employee_name,
        manager_id,
        salary,
        1 AS level
    FROM Employees
    WHERE manager_id IS NULL

    UNION ALL

    -- Recursive case: employees reporting to previous level
    SELECT
        e.employee_id,
        e.employee_name,
        e.manager_id,
        e.salary,
        h.level + 1 AS level
    FROM Employees e
    JOIN hierarchy h
        ON e.manager_id = h.employee_id
),
descendants AS (
    -- Each employee is initially their own descendant
    SELECT
        employee_id AS manager_id,
        employee_id AS employee_id,
        salary
    FROM Employees

    UNION ALL

    -- Recursively collect all indirect descendants
    SELECT
        d.manager_id,
        e.employee_id,
        e.salary
    FROM descendants d
    JOIN Employees e
        ON e.manager_id = d.employee_id
),
aggregates AS (
    SELECT
        manager_id,
        COUNT(employee_id) - 1 AS team_size,
        SUM(salary) AS budget
    FROM descendants
    GROUP BY manager_id
)
SELECT
    h.employee_id,
    h.employee_name,
    h.level,
    a.team_size,
    a.budget
FROM hierarchy h
JOIN aggregates a
    ON h.employee_id = a.manager_id
ORDER BY
    h.level ASC,
    a.budget DESC,
    h.employee_name ASC;
```
